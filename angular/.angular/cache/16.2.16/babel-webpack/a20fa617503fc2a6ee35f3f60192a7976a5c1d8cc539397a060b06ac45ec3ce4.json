{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/bagia/Desktop/S1/notes cours/Web/VersionMax/Web-Sampler-cours-1/angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { PresetsService } from '../presets.service';\nimport { environment } from '../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../presets.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction ModifySamplerComponent_ng_container_8_li_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"li\")(1, \"div\", 19)(2, \"strong\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"small\", 8);\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function ModifySamplerComponent_ng_container_8_li_2_Template_button_click_6_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r10);\n      const i_r8 = restoredCtx.index;\n      const ctx_r9 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r9.removeExistingSample(i_r8));\n    });\n    i0.ɵɵtext(7, \"\\u2715\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const s_r7 = ctx.$implicit;\n    const i_r8 = ctx.index;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(s_r7.name || \"Son \" + (i_r8 + 1));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(s_r7.url);\n  }\n}\nfunction ModifySamplerComponent_ng_container_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"ul\", 17);\n    i0.ɵɵtemplate(2, ModifySamplerComponent_ng_container_8_li_2_Template, 8, 2, \"li\", 18);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r0.existingSamples);\n  }\n}\nfunction ModifySamplerComponent_ng_template_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 8);\n    i0.ɵɵtext(1, \"Aucun son pour ce preset.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ModifySamplerComponent_ul_23_li_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r15 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"li\")(1, \"span\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function ModifySamplerComponent_ul_23_li_1_Template_button_click_3_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r15);\n      const i_r13 = restoredCtx.index;\n      const ctx_r14 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r14.removeNewFile(i_r13));\n    });\n    i0.ɵɵtext(4, \" \\u2715 \");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const file_r12 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(file_r12.name);\n  }\n}\nfunction ModifySamplerComponent_ul_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ul\", 17);\n    i0.ɵɵtemplate(1, ModifySamplerComponent_ul_23_li_1_Template, 5, 1, \"li\", 18);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r4 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r4.files);\n  }\n}\nfunction ModifySamplerComponent_div_29_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8);\n    i0.ɵɵtext(1, \"Sauvegarde en cours\\u2026\");\n    i0.ɵɵelementEnd();\n  }\n}\nexport let ModifySamplerComponent = /*#__PURE__*/(() => {\n  class ModifySamplerComponent {\n    constructor(route, svc, router) {\n      this.route = route;\n      this.svc = svc;\n      this.router = router;\n      this.originalName = '';\n      this.name = '';\n      this.urlText = '';\n      this.existingSamples = [];\n      this.files = [];\n      this.isDragOver = false;\n      this.loading = false;\n      this.loadedPreset = null;\n    }\n    ngOnInit() {\n      const routeName = this.route.snapshot.paramMap.get('name');\n      if (!routeName) {\n        alert('Aucun preset spécifié.');\n        this.router.navigate(['/']);\n        return;\n      }\n      this.loadPreset(routeName);\n    }\n    loadPreset(name) {\n      this.loading = true;\n      this.svc.getOne(name).subscribe({\n        next: p => {\n          this.loadedPreset = p;\n          this.originalName = p.name;\n          this.name = p.name;\n          this.existingSamples = Array.isArray(p.samples) ? [...p.samples] : [];\n          this.loading = false;\n        },\n        error: e => {\n          console.error(e);\n          alert('Impossible de charger le preset.');\n          this.loading = false;\n          this.router.navigate(['/']);\n        }\n      });\n    }\n    onFileSelected(event) {\n      const input = event.target;\n      if (!input.files) {\n        return;\n      }\n      const selected = [];\n      for (let i = 0; i < input.files.length; i++) {\n        const f = input.files.item(i);\n        if (f && f.type.startsWith('audio/')) selected.push(f);\n      }\n      if (!selected.length) {\n        return;\n      }\n      const combined = [...this.files, ...selected];\n      if (combined.length > 16) {\n        this.files = combined.slice(0, 16);\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      } else {\n        this.files = combined;\n      }\n    }\n    onDragOver(event) {\n      event.preventDefault();\n      this.isDragOver = true;\n    }\n    onDragLeave(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n    }\n    onDrop(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n      if (!event.dataTransfer) {\n        return;\n      }\n      const droppedFiles = [];\n      if (event.dataTransfer.files && event.dataTransfer.files.length) {\n        for (let i = 0; i < event.dataTransfer.files.length; i++) {\n          const f = event.dataTransfer.files.item(i);\n          if (f && f.type.startsWith('audio/')) droppedFiles.push(f);\n        }\n      }\n      if (!droppedFiles.length) {\n        return;\n      }\n      const combined = [...this.files, ...droppedFiles];\n      if (combined.length > 16) {\n        this.files = combined.slice(0, 16);\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      } else {\n        this.files = combined;\n      }\n    }\n    removeNewFile(index) {\n      this.files.splice(index, 1);\n      this.files = [...this.files];\n    }\n    removeExistingSample(index) {\n      this.existingSamples.splice(index, 1);\n      this.existingSamples = [...this.existingSamples];\n    }\n    isValidAudioUrl(rawUrl) {\n      return _asyncToGenerator(function* () {\n        let url = (rawUrl || '').trim();\n        if (!url) return false;\n        if (!/^https?:\\/\\//i.test(url)) {\n          const cleaned = url.replace(/^\\.?\\//, '');\n          url = `${environment.apiBase}/presets/${cleaned}`;\n        }\n        try {\n          const res = yield fetch(url, {\n            method: 'HEAD'\n          });\n          if (!res.ok) return false;\n          const ct = (res.headers.get('content-type') || '').toLowerCase();\n          return ct.startsWith('audio/') || ct.includes('octet-stream');\n        } catch {\n          return false;\n        }\n      })();\n    }\n    validateUrlSamples(samples) {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        for (const s of samples) {\n          const ok = yield _this.isValidAudioUrl(s.url);\n          if (!ok) return s.url;\n        }\n        return null;\n      })();\n    }\n    buildSamplesFromUrls(urls) {\n      return urls.map(u => {\n        const trimmed = u.trim();\n        const baseName = trimmed.split(/[\\\\/]/).pop() || 'sample';\n        return {\n          name: baseName,\n          url: trimmed\n        };\n      });\n    }\n    buildSamplesFromUpload(folderName, upload) {\n      return (upload.files || []).map(f => {\n        const baseName = (f.originalName || '').split(/[\\\\/]/).pop() || f.storedName || 'sample';\n        return {\n          name: baseName,\n          url: `./${folderName}/${f.storedName}`\n        };\n      });\n    }\n    save() {\n      var _this2 = this;\n      const rawName = (this.name || '').trim();\n      if (!rawName) {\n        alert('Veuillez saisir un nom de preset.');\n        return;\n      }\n      const name = rawName;\n      const manualUrls = (this.urlText || '').split(/\\r?\\n/).map(l => l.trim()).filter(l => !!l);\n      this.loading = true;\n      this.svc.list().subscribe({\n        next: function () {\n          var _ref = _asyncToGenerator(function* (presets) {\n            const exists = (presets || []).some(p => (p.name || '').toLowerCase() === name.toLowerCase() && p.name !== _this2.originalName);\n            if (exists) {\n              alert('Un autre preset avec ce nom existe déjà.');\n              _this2.loading = false;\n              return;\n            }\n            const hasFiles = _this2.files && _this2.files.length > 0;\n            const urlSamples = _this2.buildSamplesFromUrls(manualUrls);\n            if (urlSamples.length) {\n              const invalidUrl = yield _this2.validateUrlSamples(urlSamples);\n              if (invalidUrl) {\n                alert(`Impossible de sauvegarder le preset : l'URL \"${invalidUrl}\" ne pointe pas vers un fichier audio valide sur le serveur.`);\n                _this2.loading = false;\n                return;\n              }\n            }\n            const keepType = _this2.loadedPreset?.type || 'Custom';\n            const keepFactory = _this2.loadedPreset?.isFactoryPresets ?? false;\n            // Cas A: pas de nouveaux fichiers, on ne fait que combiner existants + URLs\n            if (!hasFiles) {\n              let samples = [..._this2.existingSamples, ...urlSamples];\n              if (samples.length > 16) {\n                samples = samples.slice(0, 16);\n                alert('Maximum 16 sons par preset. Certains sons supplémentaires ont été ignorés.');\n              }\n              const body = {\n                name,\n                type: samples.length === 0 ? 'Empty' : keepType,\n                isFactoryPresets: keepFactory,\n                samples\n              };\n              _this2.svc.update(_this2.originalName, body).subscribe({\n                next: () => {\n                  alert('Preset mis à jour.');\n                  _this2.loading = false;\n                  _this2.router.navigate(['/']);\n                },\n                error: e => {\n                  _this2.loading = false;\n                  alert('Erreur lors de la mise à jour du preset: ' + (e?.error?.error || e?.message || e));\n                }\n              });\n              return;\n            }\n            // Cas B: nouveaux fichiers (avec éventuellement des URLs en plus)\n            const folderForUpload = _this2.originalName || name;\n            _this2.svc.upload(folderForUpload, _this2.files).subscribe({\n              next: uploadRes => {\n                const fileSamples = _this2.buildSamplesFromUpload(folderForUpload, uploadRes);\n                let allSamples = [..._this2.existingSamples, ...fileSamples, ...urlSamples];\n                if (allSamples.length > 16) {\n                  allSamples = allSamples.slice(0, 16);\n                  alert('Maximum 16 sons par preset. Certains sons supplémentaires ont été ignorés.');\n                }\n                const body = {\n                  name,\n                  type: allSamples.length === 0 ? 'Empty' : keepType,\n                  isFactoryPresets: keepFactory,\n                  samples: allSamples\n                };\n                _this2.svc.update(_this2.originalName, body).subscribe({\n                  next: () => {\n                    alert('Preset mis à jour avec les nouveaux sons.');\n                    _this2.loading = false;\n                    _this2.router.navigate(['/']);\n                  },\n                  error: e => {\n                    _this2.loading = false;\n                    alert('Erreur lors de la mise à jour du preset: ' + (e?.error?.error || e?.message || e));\n                  }\n                });\n              },\n              error: e => {\n                console.error(e);\n                _this2.loading = false;\n                alert('Erreur lors de l\\'upload des fichiers audio: ' + (e?.error?.error || e?.message || e));\n              }\n            });\n          });\n          return function next(_x) {\n            return _ref.apply(this, arguments);\n          };\n        }(),\n        error: err => {\n          console.error(err);\n          this.loading = false;\n          alert('Impossible de vérifier les presets existants.');\n        }\n      });\n    }\n    static {\n      this.ɵfac = function ModifySamplerComponent_Factory(t) {\n        return new (t || ModifySamplerComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i2.PresetsService), i0.ɵɵdirectiveInject(i1.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: ModifySamplerComponent,\n        selectors: [[\"app-modify-sampler\"]],\n        decls: 30,\n        vars: 10,\n        consts: [[1, \"example-flex-container\"], [\"for\", \"preset-name\", 1, \"field-label\"], [\"id\", \"preset-name\", \"type\", \"text\", \"placeholder\", \"Nom du preset\", 3, \"ngModel\", \"ngModelChange\"], [4, \"ngIf\", \"ngIfElse\"], [\"noSamples\", \"\"], [\"for\", \"preset-urls\", 1, \"field-label\"], [\"id\", \"preset-urls\", \"rows\", \"3\", \"placeholder\", \"Ex: ./MonPreset/nouveau-kick.wav\", 3, \"ngModel\", \"ngModelChange\"], [1, \"drop-zone\", 3, \"drop\", \"dragover\", \"dragleave\"], [1, \"muted\"], [\"type\", \"button\", 1, \"action\", \"secondary\", 3, \"click\"], [\"type\", \"file\", \"multiple\", \"\", \"accept\", \"audio/*\", \"hidden\", \"\", 3, \"change\"], [\"fileInput\", \"\"], [\"class\", \"file-list\", 4, \"ngIf\"], [1, \"example-button-row\"], [1, \"action\", 3, \"disabled\", \"click\"], [\"routerLink\", \"/\", 1, \"action\", \"secondary\", 3, \"disabled\"], [\"class\", \"muted\", 4, \"ngIf\"], [1, \"file-list\"], [4, \"ngFor\", \"ngForOf\"], [1, \"file-info\"], [\"type\", \"button\", 1, \"chip-remove\", 3, \"click\"]],\n        template: function ModifySamplerComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r16 = i0.ɵɵgetCurrentView();\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ɵɵtext(2, \"Modifier le preset\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"label\", 1);\n            i0.ɵɵtext(4, \"Nom du preset\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"input\", 2);\n            i0.ɵɵlistener(\"ngModelChange\", function ModifySamplerComponent_Template_input_ngModelChange_5_listener($event) {\n              return ctx.name = $event;\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(6, \"h3\");\n            i0.ɵɵtext(7, \"Sons existants\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(8, ModifySamplerComponent_ng_container_8_Template, 3, 1, \"ng-container\", 3);\n            i0.ɵɵtemplate(9, ModifySamplerComponent_ng_template_9_Template, 2, 0, \"ng-template\", null, 4, i0.ɵɵtemplateRefExtractor);\n            i0.ɵɵelementStart(11, \"label\", 5);\n            i0.ɵɵtext(12, \"Nouvelles URLs de sons (une par ligne, optionnel)\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(13, \"textarea\", 6);\n            i0.ɵɵlistener(\"ngModelChange\", function ModifySamplerComponent_Template_textarea_ngModelChange_13_listener($event) {\n              return ctx.urlText = $event;\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(14, \"div\", 7);\n            i0.ɵɵlistener(\"drop\", function ModifySamplerComponent_Template_div_drop_14_listener($event) {\n              return ctx.onDrop($event);\n            })(\"dragover\", function ModifySamplerComponent_Template_div_dragover_14_listener($event) {\n              return ctx.onDragOver($event);\n            })(\"dragleave\", function ModifySamplerComponent_Template_div_dragleave_14_listener($event) {\n              return ctx.onDragLeave($event);\n            });\n            i0.ɵɵelementStart(15, \"p\");\n            i0.ɵɵtext(16, \"Ajouter de nouveaux fichiers audio\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(17, \"p\", 8);\n            i0.ɵɵtext(18, \"Glissez-d\\u00E9posez ici ou\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(19, \"button\", 9);\n            i0.ɵɵlistener(\"click\", function ModifySamplerComponent_Template_button_click_19_listener() {\n              i0.ɵɵrestoreView(_r16);\n              const _r3 = i0.ɵɵreference(22);\n              return i0.ɵɵresetView(_r3.click());\n            });\n            i0.ɵɵtext(20, \" Parcourir le PC\\u2026 \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(21, \"input\", 10, 11);\n            i0.ɵɵlistener(\"change\", function ModifySamplerComponent_Template_input_change_21_listener($event) {\n              return ctx.onFileSelected($event);\n            });\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(23, ModifySamplerComponent_ul_23_Template, 2, 1, \"ul\", 12);\n            i0.ɵɵelementStart(24, \"div\", 13)(25, \"button\", 14);\n            i0.ɵɵlistener(\"click\", function ModifySamplerComponent_Template_button_click_25_listener() {\n              return ctx.save();\n            });\n            i0.ɵɵtext(26, \" Enregistrer les modifications \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(27, \"button\", 15);\n            i0.ɵɵtext(28, \" Annuler \");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(29, ModifySamplerComponent_div_29_Template, 2, 0, \"div\", 16);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            const _r1 = i0.ɵɵreference(10);\n            i0.ɵɵadvance(5);\n            i0.ɵɵproperty(\"ngModel\", ctx.name);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngIf\", ctx.existingSamples.length)(\"ngIfElse\", _r1);\n            i0.ɵɵadvance(5);\n            i0.ɵɵproperty(\"ngModel\", ctx.urlText);\n            i0.ɵɵadvance(1);\n            i0.ɵɵclassProp(\"over\", ctx.isDragOver);\n            i0.ɵɵadvance(9);\n            i0.ɵɵproperty(\"ngIf\", ctx.files.length);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"disabled\", ctx.loading);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"disabled\", ctx.loading);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngIf\", ctx.loading);\n          }\n        },\n        dependencies: [i3.NgForOf, i3.NgIf, i4.DefaultValueAccessor, i4.NgControlStatus, i4.NgModel, i1.RouterLink],\n        styles: [\".example-flex-container[_ngcontent-%COMP%]{margin-top:4px;display:flex;flex-direction:column;gap:12px}.field-label[_ngcontent-%COMP%]{font-size:.9rem;font-weight:500}input[type=text][_ngcontent-%COMP%], textarea[_ngcontent-%COMP%]{width:100%;padding:8px 10px;border-radius:4px;border:1px solid rgba(0,0,0,.15);font:inherit;box-sizing:border-box}.drop-zone[_ngcontent-%COMP%]{margin-top:8px;padding:16px;border-radius:6px;border:2px dashed rgba(0,0,0,.2);text-align:center;cursor:pointer;transition:background-color .15s ease,border-color .15s ease}.drop-zone.over[_ngcontent-%COMP%]{background-color:#00000008;border-color:#0006}.file-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}.file-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:4px 8px;border-radius:6px;background:rgba(0,0,0,.04);font-size:.85rem}.file-info[_ngcontent-%COMP%]{display:flex;flex-direction:column}.chip-remove[_ngcontent-%COMP%]{border:none;background:transparent;cursor:pointer;padding:0 2px;font-size:.9rem}\"]\n      });\n    }\n  }\n  return ModifySamplerComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}